<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Cartoony MMA — Desktop/Online (v15)</title>
<meta name="theme-color" content="#0b132a">
<style>
  :root{--bg:#0a0f1e;--panel:#0f172a;--line:#1f2a3c;--text:#e2e8f0;--muted:#9aa6b2;--accent:#5b35b1;--btn:64px;--pad:12px}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
  #wrap{display:flex;flex-direction:column;height:100vh}
  header{padding:10px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0f172a,#0b1322);display:flex;gap:10px;align-items:center}
  h1{margin:0;font-size:16px;flex:1}
  #menuBtn{border:1px solid #2b3445;background:#0b1220;color:#e2e8f0;border-radius:10px;padding:8px 12px;cursor:pointer}
  #gameArea{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  #game{display:block;max-width:100vw;max-height:100%}
  #hudBar{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:8;display:flex;align-items:center;gap:12px}
  .hudShell{width:min(40vw,420px);height:22px;background:#0b1220;border-radius:18px;border:2px solid #0f1a2b;box-shadow: inset 0 6px 14px rgba(0,0,0,.45)}
  .hudFill{height:100%;border-radius:16px;margin:2px;box-shadow: inset 0 -4px 8px rgba(0,0,0,.35)}
  #hp1{background:linear-gradient(90deg,#22c55e,#86efac)} #hp2{background:linear-gradient(90deg,#f97316,#f59e0b)}
  #instr{position:absolute;top:40px;right:14px;background:#0f172a;border:1px solid #1f2a3c;border-radius:10px;padding:8px 10px;font-size:13px;opacity:.92}
  #controls{position:absolute;inset:0;pointer-events:none}
  .cluster{position:absolute;bottom:18px;display:grid;gap:var(--pad);pointer-events:auto}
  #leftCluster{left:18px;grid-template-columns:repeat(2,var(--btn));grid-auto-rows:var(--btn);}
  #rightCluster{right:18px;grid-template-columns:repeat(2,var(--btn));grid-auto-rows:var(--btn);}
  .btn{width:var(--btn);height:var(--btn);border-radius:12px;border:1px solid #2a155c;background:linear-gradient(180deg,#5b35b1,#341d73);color:#e8e4ff;font-weight:800;text-shadow:0 2px 0 rgba(0,0,0,.45); user-select:none; cursor:pointer}
  .btn small{display:block;font-size:11px;opacity:.9;margin-top:2px}
  .facebar{position:absolute;top:8px;left:8px;display:flex;gap:8px;align-items:center;z-index:6}
  .facebar img{width:38px;height:38px;border-radius:50%;border:2px solid #1f2a3c}
  .overlay{position:absolute;inset:0;background:rgba(2,6,23,.96);display:flex;align-items:center;justify-content:center;z-index:20}
  .card{background:#0f172a;border:1px solid #1f2a3c;border-radius:14px;padding:14px;max-width:min(980px,95vw);width:100%;display:flex;flex-direction:column;gap:10px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btnP{padding:10px 14px;border-radius:10px;border:1px solid #2b6cb0;background:#1e3a8a;color:#e5edff;font-weight:700;cursor:pointer}
  .btnG{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:transparent;color:#e2e8f0;cursor:pointer}
  input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid #263245;background:#0b1220;color:#e2e8f0;min-width:120px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  .cardlet{background:#0b1220;border:1px solid #1f2a3c;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;cursor:pointer;align-items:center}
  .face{width:96px;height:96px;border-radius:50%;overflow:hidden;background:#0b1220;border:1px solid #1f2a3c}
  .face img{width:100%;height:100%;object-fit:cover}
  .name{font-weight:700;font-size:14px;text-align:center}
  .muted{color:#9aa6b2;font-size:12px;text-align:center}
  .pickRow{display:flex;gap:12px;align-items:center;justify-content:space-between;border:1px dashed #2b3445;border-radius:10px;padding:10px}
  .pill{background:#0b1220;border:1px solid #223047;border-radius:999px;padding:6px 10px;font-size:12px}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>Cartoony MMA — Desktop/Online</h1>
    <button id="menuBtn" title="Open menu">☰ Menu</button>
  </header>
  <div id="gameArea">
    <canvas id="game" width="1280" height="720" aria-label="game canvas"></canvas>

    <div class="facebar"><img id="p1Face" src="{P_N}"><img id="p2Face" src="{P_T}"></div>

    <div id="hudBar" aria-hidden="true">
      <div class="hudShell"><div id="hp1" class="hudFill" style="width:100%"></div></div>
      <div id="roundLabel">Round 1</div>
      <div class="hudShell"><div id="hp2" class="hudFill" style="width:100%"></div></div>
    </div>

    <div id="instr">Controls:<br>Left/Right buttons move<br><b>Z</b>=Punch, <b>X</b>=Block (hold), <b>C</b>=Kick, <b>V</b>=Jump</div>

    <div id="controls">
      <div id="leftCluster" class="cluster">
        <button class="btn" id="btnLeft">Left</button>
        <button class="btn" id="btnRight">Right</button>
      </div>
      <div id="rightCluster" class="cluster">
        <button class="btn" id="btnPunch">Punch<small>Z</small></button>
        <button class="btn" id="btnBlock">Block<small>X</small></button>
        <button class="btn" id="btnKick">Kick<small>C</small></button>
        <button class="btn" id="btnJump">Jump<small>V</small></button>
      </div>
    </div>

    <div id="menu" class="overlay">
      <div class="card">
        <div class="row"><b>Play mode</b></div>
        <div class="row">
          <button id="soloBtn" class="btnP">Solo vs CPU</button>
          <button id="hostBtn" class="btnG" title="Needs Firebase wiring">Host Online Match</button>
          <input id="joinCode" type="text" placeholder="Enter code" maxlength="6">
          <button id="joinBtn" class="btnG" title="Needs Firebase wiring">Join</button>
        </div>

        <div class="pickRow">
          <div><b>Your Fighter:</b> <span id="p1Choice" class="pill">None</span></div>
          <div id="p2Row"><b>Opponent:</b> <span id="p2Choice" class="pill">None</span></div>
          <div id="hostInfo" style="display:none"><b>Room code:</b> <span id="roomDisplay" class="pill">------</span> <button id="copyLink" class="btnG">Copy Link</button></div>
        </div>

        <div class="muted">Choose fighters below. In Solo you pick both. Keyboard: A/D or arrows move; Z Punch, X Block (hold), C Kick, V Jump.</div>

        <div><b>Choose Fighters</b></div>
        <div id="selectGrid" class="grid"></div>

        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="randomBoth" class="btnG">Random Both</button>
          <button id="restartRound" class="btnG">Restart Round</button>
          <button id="startMatch" class="btnP">Start Match ▶</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const ROSTER = [
  {{ id:'nic',   name:'Nine‑Second Nic', bio:'Claims every fight ends in nine seconds.', face:'faces/nic.jpg',   fallback:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAD0ElEQVR42u2dS2tTQRTH/zNNi1rig9ZXVLQYtZUW45vaEBREqnXRz9CdS7+Caz+DCz9D0SKC4gvFigpSH2DdWEWoiiJCrSEuipuSyU3mzrlzZu75bycv/r8558w9N8kBRKI8S4XyQftL+xudPmfx0zslADIyO1QoKg+mc4ah8mY6NxgqFOPHp952/D4z1w6wB6E4Gm9jtmsoWYFQXIynND0NDGoQKo/GcwKhfJjPwXQbGBQQVJbmcza+XRCuISjZ9X6jQcmu9xsNWsy3Pxa7uJDUYr5fCMq1+bEZ325Ksk1HWsx3Ew22kaDFfL8QtJjvF4Km+BB5h0AGgFP/nrM68UmnedG8734XqUiL+X4haFdvJrLzRdvsfpG7eqBl9/uNAt0JPTHfDkKrKNBil18pX7t/pAxMTbb32OdvgOvTnb1+sRe4cin5cZev0pm7umnXrGEXRARUBoEdW+KMAB3CyUcBuFiL80TUVgRwKL6De4DyrvhOREEV4RiiIBEA56Pn7u3AyL64jqTBHUMnqoBWEUcAd23tA44PRwoglCvf8VNAoRBHGgrySnhjEahWJAV51dmTwJoeAUCq5b/mtd61wJkTAoBUH78AHxbM66ePAsV1kQDgWoCn75nXerqBc6NhF2L2NWB+AZibN6+PHgL6NkgKIo+ChqE92KWBC1UBQKrPi8Cz1+b1w0NAabMAINXNh0C93nwt5HZ1MAC+/QAevTSvDw0Ae3cKAFLdegwsLZvXJ2oCgFS/fgN3Z83rAyVguCwASHXn6QoIYxRUAaUEAJmW/gC3n5jXt/UDxw4KAFI9eAF8/2lePz8GFLoEAJnq9ZVjqUmb1gNjFQFAqtm5lQs0k2pHAgOw+ltbNn92lKUaDeDGffN6N7M7ZqZvyQX93dBX71u3qyUFZaBW7WoBkIGS2tUCIKMoaDQiABBaIf6vpHY11wIcTQQAwEyLdrWkoAz0NaFdHQyAUNMQkNyu5pZ+oooAILldHWwKCikKktrVPnd/M3n7kV4eFM2P9GKWEUDIxTiU3S8RwL0ISxTQ7n6rCBAIbv1JBBDCJCLOSvJPZ0FZdn9KAM0oCoRkP9rJHjpNKAmEdOZ3nIKkHrj3SVPQl7zvuAZIKnKfelJFgEBw9xf21ikozxBczg9IXVTzMkGj1QZLczhJXYRNbx5bNFAN8nHSDY0dAuUUJZkjZnnEZDdHLLa6EOQkvRiiIYpZku1A4AQjymmqIYCIfp6wDQhqGLmcqG0LIi0UmSlPAIJKvlrtbPr7PmBwuL/B8gYLJQxuN5WCucNlA0Xu4IkS9Q88p9ql5Uk8ggAAAABJRU5ErkJggg==' }},
  {{ id:'ty',    name:'Ty “Boulder Dome”', bio:'Bald, bearded, built like a loading dock.', face:'faces/ty.jpg', fallback:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAACnUlEQVR42u2dr04DQRDGbycEg8BUEYJEkvAOCJ4AQ4LlmTAICIZnwCAgQTWp7AM0Ia1rqhDgS//c7c7ezN7+Pt32mu+338x2r+00DUI1K5TyRkcn579dn7OYTQMAejK7VCihBtM9wwi1me4NRijF+Lu3+87Xebp6cA8ieDQ+xmxtKH2BCF6Mz2l6CozcIEKNxnsCESzM92B6DIwcEEKf5ns2vi0IbQiBVW+bhsCqt02DYH78tljjg6Rgvi2EoG3+0IxvW5Jiy5Fgvk4aYpMgmG8LQTDfFoLkeBO1Q8gGwNP5vWd18UlSXrT21a9RigTzbSGI1sVQnC8Ss/qRXj8QVr9tCqQLPcyPg7ArBYJdtgpWq/92dNOcHZ6aG/C5/Grelx9ZXnv90G7TgR0JMJaw87HdEbVKAM03346IEuStBLH17HdLSgKMdWB14ZfFa6fHXx5dNNfHV3sf9zh/br5/5mWWIMpP/2WIEuTxcwACAABQzwBowDaNmARQggCAAAAABAAAIAAAAAEAAAgAFQJY/9ZWzJ8doe3a9i05EkAJAgACAABoxAYNmARQgtA/AJSh/soPCSilBJECndW/SRu/Hb2YTYO3nymNV5NmvJoUDYQf6ZVUgmjGeZsvCSihCZOCvKs/KgFA0PVnL4ASJhGVtvNJ7gGkQM8XiaUIhP1+tKkekhIlIKSZ37kE0Q/0fZIc9Kn7yj2AUqRfepISAAS9v7CPLkE1Q9CcH5DcVGuZoLFrgaVsTpKb8LaLDy0NuQb5qJyGDh1CzilKzBGL3GK6myM2tL5Q5CS9IaRhELMk20DwBGOQ01RLADH4ecIxIHLDqHKidiyIVCjMlM8AIpesjtrdnO9bwPBwf8PlDZacMLzdVCrmDlcMFO7gob36AzpuhcbtAEdAAAAAAElFTkSuQmCC' }},
  {{ id:'roger', name:'Roger “Redline”',   bio:'Red‑bearded engine that never cools.',      face:'faces/roger.jpg', fallback:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAEs0lEQVR42u2dz2tUVxTHv+dmMklmIsYoFAJaf6OLFmxajFa0tF1UdKELs2gXJRS69Y/RvS6LhSxKoS7qD0pVShZt8EdNrKIQDPkxMSr+yEy8t4tBCJL47rx379zz7jsHZndn3nvfzz0/7n3vzQHExIpslJcT3TSw27T6nfnHkyQA2iR2XqFQEUTnDIOKJjo3GJQX4SdHTrV8nN3nfmYPgjgKn0Zs11DaBYK4CO9T9CwwfIOgIgrPCQSFEJ+D6Glg+IBA7RSfs/C2IFxDIJn1Yb2BZNaH9QYl4qcvi10sJJWIHxYCuRY/NuFtQ1LacKREfDfekNYTlIgfFoIS8cNCUD5OougQvAHgtH/P2VrRSWX50aLPfhehSIn4YSEoVwcTS6eLSjP7xdzlAyWzP6wXqFboifjpILzPC5TIFdYo9Ow3u/ZCn/gu5ZcN0Kg3P/U66NkiUJsD1WZBD/8DFheCivvupt1qG3alfE8fAspdzU8VMBs2Ah/uwNuZQ/MzoPEx0D9jgH7D8hJUzJWP2fQB9FfH8eaH0zADW1hWRFY5IPfJt68fengEZutOdhVRcZJwZyf08WGgp8I7BEVdevZUoA99zaokLVwZavZ8BCg+l52bKkhdOAd6dH9FBaSAchmmrx/YuhN68CBQ7U3+oe4emIHNoKlH/EJQrsKP0cDSa9DMY9Bff6Dj/Bng6RPrpMwlDMUTgl6+gLpx1W5spZePZ0e1rJ96aDewoyQAvNjrV3bjll4JAF9lppXV5vgBiKH+N5u3JQ9aXgZNT7X93NZKxPF4QLUXeuhIcp6YuAXUl2QdkD3jNndCW1oHNBpQ1y6xuozcANDDIxnjk4G6OGq/VhAADq2+BPXbKGjyNrtTixuA1qA741B//g48f8ryFOMFsLgA9euFIBVPcdcBK62vH/rbH6G/PMZq5VscAACgFMzgAehT3wOlTgEQcoGmj56UHJBppqy8H1AqAevWw2zZDv3ZIWDDxmQIez6GeXAPdPtv8YDMtrwMPKmBxsfQcf4s6MGEXVH0xTdAV7cAcAujAfXLT6D52eSxlSr0/sM8Abz71FaaPzsKZo0G6OIogOTHmcwnQ0Cl2vZTXOspuWiSME1Pge7eTB7YWW7mDQlBHi7m2pXm86JJXrBvP5vng+IqQxfmQBP58oLo1gHq+lW7XLBviIUXqNUSQy4T8VurzYIm7iSPK5ehP/08aAKOdiVMNy7bV0TdPRKCnAOYmwHd+9fCC7ra5gXWAKIIQwDo+hWrcWbwgFcvSHpLJtrNOJqdBt2/a+cFgwd5h6BCeIGHPSIb3YK/pBez2bykJ6+pcl2IxZKMOc9+8QDuWxHiBX5nfyoPEAhu9UkEkIdORJwtST/VDsoy+zMCWI2iQEjWwyZ6qCyuJBCyid9yCJJ84F4n5YO+xH3HOUBCkfvQk8kDBIK7v7BPHYKKDMFl/4DMSbUoHTTeN8GyFCeZk/BaB4/NG3w18nGyGxo7BJ9dlKSPWMoSk10fsdjyQi476cXgDVH0krSBwAlGlN1U8wAi+n7CaUD4hlHIjtppQWSFIj3lPYDwZaG22tns74eAweH+BssbLD5hcLuplJs7XGmgyB08sUT7H+GxPL/bWHeNAAAAAElFTkSuQmCC' }}
];
</script>

<script>
const DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
const hp1=document.getElementById('hp1'), hp2=document.getElementById('hp2');
const p1FaceEl=document.getElementById('p1Face'), p2FaceEl=document.getElementById('p2Face');
const state={width:1280,height:720,arena:{left:120,right:1160,ground:600},t:0, round:1, paused:true};
function fitCanvas(){ const headerH=document.querySelector('header').offsetHeight||48; const vw=window.innerWidth, vh=window.innerHeight-headerH;
  let cssW=vw, cssH=Math.round(vw*9/16); if(cssH>vh){ cssH=vh; cssW=Math.round(cssH*16/9); }
  canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px'; canvas.width=Math.round(cssW*DPR); canvas.height=Math.round(cssH*DPR); ctx.setTransform(DPR,0,0,DPR,0,0);
  state.width=cssW; state.height=cssH; state.arena.ground=Math.round(cssH*0.86); state.arena.left=Math.round(cssW*0.06); state.arena.right=Math.round(cssW*0.94);
} window.addEventListener('resize',fitCanvas); fitCanvas();
function drawArena(){const W=state.width,H=state.height;const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#0b132a');bg.addColorStop(1,'#0a0f1e');ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
  const top=H*0.25, bot=state.arena.ground, pad=28, left=pad, right=W-pad; ctx.strokeStyle='#132038'; ctx.lineWidth=12; ctx.lineJoin='round';
  ctx.beginPath(); ctx.moveTo(left,top+10); ctx.lineTo(right,top+10); ctx.lineTo(right-6,bot); ctx.lineTo(left+6,bot); ctx.closePath(); ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.beginPath(); ctx.ellipse(W*0.5,bot-6, W*0.28, 18, 0, 0, Math.PI*2); ctx.fill(); }
</script>

<script>
function loadFace(src, fallback){ const img=new Image(); img.decoding='async'; img._ready=false;
  img.onload=()=>{ img._ready=true; }; img.onerror=()=>{ img.src=fallback; img._ready=true; }; img.src = src || fallback; return img; }
const Faces={}; ROSTER.forEach(r=> Faces[r.id]=loadFace(r.face, r.fallback));
function makeF(x,dir,id){ return { id, x, y:state.arena.ground, vy:0, dir, onGround:true, hp:100, action:'idle', cd:0, stun:0, speed:360, t:0 }; }
const p1=makeF(state.width*0.3, 1, 'nic'); const p2=makeF(state.width*0.7,-1, 'ty');
function resetPositions(){ p1.x=state.width*0.3; p1.y=state.arena.ground; p1.vy=0; p1.hp=100; p1.action='idle'; p1.stun=0; p1.cd=0; p1.onGround=true;
  p2.x=state.width*0.7; p2.y=state.arena.ground; p2.vy=0; p2.hp=100; p2.action='idle'; p2.stun=0; p2.cd=0; p2.onGround=true; }
function dist(a,b){ return Math.abs(a.x-b.x); } function front(att,def){ return Math.sign(def.x-att.x)===att.dir; }
const inPunch=(a,d)=>dist(a,d)<=72&&front(a,d); const inKick=(a,d)=>dist(a,d)<=104&&front(a,d);
function drawFighter(f,tint){ ctx.fillStyle='rgba(0,0,0,0.30)'; ctx.beginPath(); ctx.ellipse(f.x,f.y-4,26,8,0,0,Math.PI*2); ctx.fill();
  const torso=86, head=28, limb=50, thick=14; const baseY=f.y-6; ctx.fillStyle=tint; ctx.strokeStyle='#0a1022'; ctx.lineWidth=3;
  ctx.beginPath(); if(ctx.roundRect) ctx.roundRect(f.x-22, baseY-torso, 44, torso, 12); else { ctx.rect(f.x-22, baseY-torso, 44, torso); } ctx.fill(); ctx.stroke();
  const img=Faces[f.id]; const canDraw=img && img.complete && img.naturalWidth>0; const cx=f.x, cy=baseY-(torso+head/2+4);
  if(canDraw){ ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,head,0,Math.PI*2); ctx.clip(); ctx.drawImage(img, cx-head, cy-head, head*2, head*2); ctx.restore();
               ctx.strokeStyle='#1f2a3c'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(cx,cy,head,0,Math.PI*2); ctx.stroke(); }
  else { ctx.fillStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(cx,cy,head,0,Math.PI*2); ctx.fill(); ctx.stroke(); }
  let la=0,ra=0,ll=0,rl=0; if(f.action==='punch'){ ra=-0.2*f.dir; la=0.6*f.dir; rl=0.2; ll=-0.1; } else if(f.action==='kick'){ rl=-0.9; ll=0.3; ra=0.2*f.dir; la=0.2*f.dir; } else if(f.action==='block'){ ra=-1.0*f.dir; la=1.0*f.dir; }
  function limbRect(cx,cy,len,ang){ ctx.save(); ctx.translate(cx,cy); ctx.rotate(ang); if(ctx.roundRect) ctx.roundRect(-thick/2,-thick/2,len,thick,8); else ctx.rect(-thick/2,-thick/2,len,thick); ctx.restore(); }
  ctx.fillStyle='#1f2a3c'; ctx.strokeStyle='#071127'; ctx.beginPath(); limbRect(f.x-20, baseY-(torso*0.7), limb, la + (f.dir<0?Math.PI:0)); limbRect(f.x+20, baseY-(torso*0.7), limb, ra + (f.dir>0?0:Math.PI)); ctx.fill(); ctx.stroke();
  ctx.beginPath(); limbRect(f.x-12, baseY-18, limb, ll + (f.dir<0?Math.PI:0)); limbRect(f.x+12, baseY-18, limb, rl + (f.dir>0?0:Math.PI)); ctx.fill(); ctx.stroke(); }
</script>

<script>
const input={left:false,right:false,punch:false,kick:false,block:false,jump:false};
const KeyMap={'ArrowLeft':'left','ArrowRight':'right','z':'punch','x':'block','c':'kick','v':'jump','Z':'punch','X':'block','C':'kick','V':'jump','a':'left','d':'right','A':'left','D':'right'};
addEventListener('keydown', e=>{ if(e.repeat) return; const k=KeyMap[e.key]; if(k) input[k]=true; });
addEventListener('keyup',   e=>{ const k=KeyMap[e.key]; if(k) input[k]=false; });
function bindHold(id,key){ const el=document.getElementById(id); const on=e=>{e.preventDefault(); input[key]=true;}; const off=e=>{e.preventDefault(); input[key]=false;};
  ['pointerdown','mousedown','touchstart'].forEach(ev=>el.addEventListener(ev,on));
  ['pointerup','pointercancel','mouseleave','mouseup','touchend','touchcancel'].forEach(ev=>el.addEventListener(ev,off));
} ['btnLeft','btnRight','btnPunch','btnBlock','btnKick','btnJump'].forEach((id,i)=>bindHold(id,['left','right','punch','block','kick','jump'][i]));
</script>

<script>
const GRAV=1400; const distFn=(a,b)=>Math.abs(a.x-b.x); const inPunchFn=(a,d)=>distFn(a,d)<=72&&front(a,d); const inKickFn=(a,d)=>distFn(a,d)<=104&&front(a,d);
function doPunch(a,d){ a.action='punch'; a.cd=.28; if(inPunchFn(a,d)){ d.hp=Math.max(0,d.hp-(d.action==='block'?6:12)); d.stun=(d.action==='block'?0.05:0.12); } }
function doKick(a,d){ a.action='kick';  a.cd=.42; if(inKickFn(a,d)){ d.hp=Math.max(0,d.hp-(d.action==='block'?8:16)); d.stun=(d.action==='block'?0.06:0.16); } }
function doBlock(a){ a.action='block'; a.cd=0; } function doJump(a){ if(a.onGround){ a.vy=-620; a.onGround=false; } }
function step(me,op,dt,inp,ai=false){ me.t+=dt; me.stun=Math.max(0,me.stun-dt); me.cd=Math.max(0,me.cd-dt);
  let vx=0; if(inp.left) vx-=me.speed; if(inp.right) vx+=me.speed; me.x=Math.max(state.arena.left,Math.min(state.arena.right, me.x+vx*dt));
  me.vy+=GRAV*dt; me.y+=me.vy*dt; if(me.y>=state.arena.ground){ me.y=state.arena.ground; me.vy=0; me.onGround=true; }
  if(inp.block) doBlock(me); else if(me.stun<=0 && me.cd<=0){ if(inp.kick) doKick(me,op); else if(inp.punch) doPunch(me,op); } if(inp.jump) doJump(me);
  if(ai){ const d=distFn(me,op), want=92; const toward=Math.sign(op.x-me.x);
    if(d>want+6) me.x += toward*me.speed*0.55*dt; else if(d<want-6) me.x -= toward*me.speed*0.55*dt;
    if(me.cd<=0){ if(Math.random()<0.02 && inKickFn(me,op)) doKick(me,op); else if(Math.random()<0.04 && inPunchFn(me,op)) doPunch(me,op); }
    if(op.action==='punch'||op.action==='kick'){ if(Math.random()<0.04) doBlock(me); }
    if(Math.random()<0.007 && me.onGround) doJump(me);
  } }
function faceEach(a,b){ a.dir=(b.x>=a.x)?1:-1; b.dir=(a.x>=b.x)?1:-1; }
let last=performance.now(); function loop(now){ const dt=Math.min((now-last)/1000,0.033); last=now; state.t+=dt;
  if(!state.paused){ faceEach(p1,p2); step(p1,p2,dt,input,false); step(p2,p1,dt,{},true); }
  ctx.clearRect(0,0,canvas.width,canvas.height); drawArena(); drawFighter(p1,'#6ea8ff'); drawFighter(p2,'#fba163'); hp1.style.width=p1.hp+'%'; hp2.style.width=p2.hp+'%';
  requestAnimationFrame(loop); } requestAnimationFrame(loop);
</script>

<script>
const menu=document.getElementById('menu'); const menuBtn=document.getElementById('menuBtn');
const grid=document.getElementById('selectGrid'); const p1Choice=document.getElementById('p1Choice'); const p2Choice=document.getElementById('p2Choice');
const p2Row=document.getElementById('p2Row'); const startBtn=document.getElementById('startMatch'); const restartBtn=document.getElementById('restartRound');
const randomBoth=document.getElementById('randomBoth'); const hostBtn=document.getElementById('hostBtn'); const soloBtn=document.getElementById('soloBtn');
const joinBtn=document.getElementById('joinBtn'); const joinCodeInput=document.getElementById('joinCode'); const hostInfo=document.getElementById('hostInfo');
const roomDisplay=document.getElementById('roomDisplay'); const copyLink=document.getElementById('copyLink');
let mode='solo', selectedP1=null, selectedP2=null;
function safeFaceSrc(src,fallback){ const img=new Image(); img.onerror=()=> img.src=fallback; img.src=src||fallback; return img.src; }
function renderRoster(){ grid.innerHTML=''; ROSTER.forEach((r)=>{ const card=document.createElement('div'); card.className='cardlet';
  const src=safeFaceSrc(r.face,r.fallback); card.innerHTML='<div class="face"><img src="'+src+'" alt="'+r.name+'"></div><div class="name">'+r.name+'</div><div class="muted">'+r.bio+'</div>';
  card.onclick=()=>{ if(mode==='solo'){ if(!selectedP1){ selectedP1=r.id; p1Choice.textContent=r.name; p1.id=r.id; p1FaceEl.src=src; } else if(!selectedP2){ selectedP2=r.id; p2Choice.textContent=r.name; p2.id=r.id; p2FaceEl.src=src; } else { selectedP2=r.id; p2Choice.textContent=r.name; p2.id=r.id; p2FaceEl.src=src; } }
                    else { selectedP1=r.id; p1Choice.textContent=r.name; p1.id=r.id; p1FaceEl.src=src; } };
  grid.appendChild(card); }); } renderRoster();
function setMode(m){ mode=m; if(mode==='solo'){ p2Row.style.display=''; hostInfo.style.display='none'; } else if(mode==='host'){ p2Row.style.display='none'; hostInfo.style.display='flex'; } else { p2Row.style.display='none'; hostInfo.style.display='none'; } }
soloBtn.onclick=()=> setMode('solo'); function genCode(){ return Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(2,8); } let roomCode=null;
hostBtn.onclick=()=>{ setMode('host'); if(!selectedP1){ const r=ROSTER[0]; selectedP1=r.id; p1Choice.textContent=r.name; p1.id=r.id; p1FaceEl.src=safeFaceSrc(r.face,r.fallback); }
  roomCode=genCode(); roomDisplay.textContent=roomCode; copyLink.onclick=()=>{ const url=location.href.split('#')[0].split('?')[0]+'?room='+roomCode; navigator.clipboard?.writeText(url); alert('Link copied:\n'+url); }; };
joinBtn.onclick=()=>{ setMode('join'); const code=(joinCodeInput.value||'').trim(); if(code) roomCode=code.toUpperCase(); };
randomBoth.onclick=()=>{ const a=ROSTER[Math.floor(Math.random()*ROSTER.length)], b=ROSTER[Math.floor(Math.random()*ROSTER.length)];
  selectedP1=a.id; selectedP2=b.id; p1Choice.textContent=a.name; p2Choice.textContent=b.name; p1.id=a.id; p2.id=b.id; p1FaceEl.src=safeFaceSrc(a.face,a.fallback); p2FaceEl.src=safeFaceSrc(b.face,b.fallback); };
function startGame(){ if(mode==='solo' && (!selectedP1||!selectedP2)){ alert('Select both fighters first.'); return; } if((mode==='host'||mode==='join') && !selectedP1){ alert('Pick your fighter first.'); return; }
  state.paused=false; resetPositions(); menu.style.display='none'; } startBtn.onclick=startGame; menuBtn.onclick=()=>{ state.paused=true; menu.style.display='flex'; };
restartBtn.onclick=()=> resetPositions();
const params=new URLSearchParams(location.search); const pre=params.get('room'); if(pre){ joinCodeInput.value=pre; setMode('join'); }
state.paused=true; menu.style.display='flex';
</script>
</body></html>
